<!doctype html>

<title>Bantisocial</title>

<link rel='stylesheet' href='styles.css'>
<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/katex@0.9.0-alpha2/dist/katex.min.css'>

<body>
  <server-sidebar></server-sidebar>

  <div class='modal-page-cover' style='display: none'></div>

  <script src='https://cdn.jsdelivr.net/combine/npm/riot@3/riot+compiler.min.js,npm/dutier@1,npm/dutier-logger@0.0.1,npm/riotcontrol@0.0.3,npm/katex@0.9.0-alpha2'></script>

  <script src='/tags/modal.tag' type='riot/tag'></script>
  <script src='/tags/fancy-input.tag' type='riot/tag'></script>
  <script src='/tags/server-sidebar.tag' type='riot/tag'></script>
  <script src='/tags/message-group.tag' type='riot/tag'></script>

  <script>
    'use strict'

    // Constants
    const SECOND = 1000
    const MINUTE = 60 * SECOND
    const HOUR   = 60 * MINUTE
    const DAY    = 24 * HOUR

    // Utilities
    function post(serverURL, path, dataObj) {
      return fetch('//' + serverURL + '/api/' + path, {
        method: 'post',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(dataObj)
      }).then(res => res.json())
    }

    function get(serverURL, path) {
      return fetch('//' + serverURL + '/api/' + path).then(res => res.json())
    }

    // State
    class Store {
      constructor() {
        riot.observable(this)
      }
    }

    RiotControl.addStore(new Store())
    RiotControl.on('*', console.log)

    let currentServerURL = null
    RiotControl.on('switch_server', url => {
      currentServerURL = url
      localStorage.currentServerURL = url

      const serverSessionIDMap = JSON.parse(localStorage.serverSessionIDMap || '{}')
      const sessionID = serverSessionIDMap[url] || null

      // Defer this a little to allow others to react to the
      // switch_server event.
      setTimeout(() => {
        RiotControl.trigger('session_id_update', sessionID)
      }, 10)
    })

    RiotControl.on('session_id_update', sessionID => {
      const serverSessionIDMap = JSON.parse(localStorage.serverSessionIDMap || '{}')

      // Update localStorage sessionID persistence
      serverSessionIDMap[currentServerURL] = sessionID

      localStorage.serverSessionIDMap = JSON.stringify(serverSessionIDMap)
    })

    // Compile Riot tags and mount them to the view
    riot.compile(() => {
      const tags = riot.mount('*')

      const servers = JSON.parse(localStorage.serverSessionIDMap || `{ ${location.host}: null }`)

      for (const serverURL of Object.keys(servers)) {
        RiotControl.trigger('add_server', serverURL)
      }

      RiotControl.trigger('switch_server', localStorage.currentServerURL || location.host)
    })
  </script>
</body>
